(function($){"use strict";if(typeof console==="undefined"||typeof console.log==="undefined"){console={};console.log=function(){};}$.fn.tagsManager=function(options,tagToManipulate){var obj=this;var rndid="";var tagManagerOptions={prefilled:null,CapitalizeFirstLetter:false,preventSubmitOnEnter:true,isClearInputOnEsc:true,AjaxPush:null,AjaxPushAllTags:null,AjaxPushParameters:null,delimiters:[9,13,44],backspace:[8],maxTags:0,hiddenTagListName:null,hiddenTagListId:null,replace:true,output:null,deleteTagsOnBackspace:true,tagsContainer:null,tagCloseIcon:'x',tagClass:'',validator:null,onlyTagList:false};if(!(0 in this)){return this;}if(typeof options=='string'){tagManagerOptions=obj.data("tm_options");}else{$.extend(tagManagerOptions,options);obj.data("tm_options",tagManagerOptions);}if(typeof options=='string'){rndid=obj.data("tm_rndid");}else{var albet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";for(var i=0;i<5;i++)rndid+=albet.charAt(Math.floor(Math.random()*albet.length));obj.data("tm_rndid",rndid);}if(tagManagerOptions.replace===true&&tagManagerOptions.hiddenTagListName===null){var original_name=obj.attr('name');tagManagerOptions.hiddenTagListName=original_name;obj.attr('name',"display-"+rndid);}if(tagManagerOptions.hiddenTagListName===null){tagManagerOptions.hiddenTagListName="hidden-"+rndid;}var delimiters=tagManagerOptions.delimeters||tagManagerOptions.delimiters;var keyNums=[9,13,17,18,19,37,38,39,40];var delimiterChars=[],delimiterKeys=[];$.each(delimiters,function(i,v){if($.inArray(v,keyNums)!=-1){delimiterKeys.push(v);}else{delimiterChars.push(v);}});var baseDelimiter=String.fromCharCode(delimiterChars[0]||44);var backspace=tagManagerOptions.backspace;var tagBaseClass='tm-tag';var inputBaseClass='tm-input';if($.isFunction(tagManagerOptions.validator))obj.data('validator',tagManagerOptions.validator);var tagClasses=function(){var cl=tagBaseClass;if(obj.attr('class')){$.each(obj.attr('class').split(' '),function(index,value){if(value.indexOf(inputBaseClass+'-')!=-1){cl+=' '+tagBaseClass+value.substring(inputBaseClass.length);}});}cl+=(tagManagerOptions.tagClass?' '+tagManagerOptions.tagClass:'');return cl;};var trimTag=function(tag){tag=$.trim(tag);var i=0;for(i;i<tag.length;i++){if($.inArray(tag.charCodeAt(i),delimiterChars)!=-1)break;}return tag.substring(0,i);};var showOrHide=function(){var tlis=obj.data("tlis");if(tagManagerOptions.maxTags>0&&tlis.length<tagManagerOptions.maxTags){obj.show();obj.trigger('tm:show');}if(tagManagerOptions.maxTags>0&&tlis.length>=tagManagerOptions.maxTags){obj.hide();obj.trigger('tm:hide');}};var popTag=function(){var tlis=obj.data("tlis");var tlid=obj.data("tlid");if(tlid.length>0){var tagId=tlid.pop();var tagBeingRemoved=tlis[tlis.length-1];obj.trigger('tm:popping',tagBeingRemoved);tlis.pop();$("#"+rndid+"_"+tagId).remove();refreshHiddenTagList();obj.trigger('tm:popped',tagBeingRemoved);}showOrHide();};var empty=function(){var tlis=obj.data("tlis");var tlid=obj.data("tlid");while(tlid.length>0){var tagId=tlid.pop();tlis.pop();$("#"+rndid+"_"+tagId).remove();refreshHiddenTagList();}obj.trigger('tm:emptied',null);showOrHide();};var refreshHiddenTagList=function(){var tlis=obj.data("tlis");var lhiddenTagList=obj.data("lhiddenTagList");if(lhiddenTagList){$(lhiddenTagList).val(tlis.join(baseDelimiter)).change();}obj.trigger('tm:refresh',tlis.join(baseDelimiter));};var spliceTag=function(tagId){var tlis=obj.data("tlis");var tlid=obj.data("tlid");var p=$.inArray(tagId,tlid);if(-1!=p){var tagBeingRemoved=tlis[p];obj.trigger('tm:splicing',tagBeingRemoved);$("#"+rndid+"_"+tagId).remove();tlis.splice(p,1);tlid.splice(p,1);refreshHiddenTagList();obj.trigger('tm:spliced',tagBeingRemoved);}showOrHide();};var pushAllTags=function(e,tag){if(tagManagerOptions.AjaxPushAllTags){if(e.type!='tm:pushed'||$.inArray(tag,tagManagerOptions.prefilled)==-1){var tlis=obj.data("tlis");$.post(tagManagerOptions.AjaxPush,{tags:tlis.join(baseDelimiter)});}}};var pushTag=function(tag,ignore_events){tag=trimTag(tag);if(!tag||tag.length<=0)return;if(tagManagerOptions.CapitalizeFirstLetter&&tag.length>1){tag=tag.charAt(0).toUpperCase()+tag.slice(1).toLowerCase();}if(obj.data('validator')&&!obj.data('validator')(tag))return;var tlis=obj.data("tlis");var tlid=obj.data("tlid");if(tagManagerOptions.maxTags>0&&tlis.length>=tagManagerOptions.maxTags)return;var alreadyInList=false;var tlisLowerCase=tlis.map(function(elem){return elem.toLowerCase();});var p=$.inArray(tag.toLowerCase(),tlisLowerCase);if(-1!=p){alreadyInList=true;}if(alreadyInList){var pTagId=tlid[p];$("#"+rndid+"_"+pTagId).stop().animate({backgroundColor:tagManagerOptions.blinkBGColor_1},100).animate({backgroundColor:tagManagerOptions.blinkBGColor_2},100).animate({backgroundColor:tagManagerOptions.blinkBGColor_1},100).animate({backgroundColor:tagManagerOptions.blinkBGColor_2},100).animate({backgroundColor:tagManagerOptions.blinkBGColor_1},100).animate({backgroundColor:tagManagerOptions.blinkBGColor_2},100);}else{if(!ignore_events)obj.trigger('tm:pushing',tag);var max=Math.max.apply(null,tlid);max=max==-Infinity?0:max;var tagId=++max;tlis.push(tag);tlid.push(tagId);if(!ignore_events)if(tagManagerOptions.AjaxPush!=null){if($.inArray(tag,tagManagerOptions.prefilled)==-1){$.post(tagManagerOptions.AjaxPush,$.extend({tag:tag},tagManagerOptions.AjaxPushParameters));}}var newTagId=rndid+'_'+tagId;var newTagRemoveId=rndid+'_Remover_'+tagId;var escaped=$("<span></span>").text(tag).html();var html='<span class="'+tagClasses()+'" id="'+newTagId+'">';html+='<span>'+escaped+'</span>';html+='<a href="#" class="tm-tag-remove" id="'+newTagRemoveId+'" TagIdToRemove="'+tagId+'">';html+=tagManagerOptions.tagCloseIcon+'</a></span> ';var $el=$(html);if(tagManagerOptions.tagsContainer!=null){$(tagManagerOptions.tagsContainer).append($el);}else{if(tagId>1){var lastTagId=tagId-1;var lastTagObj=$("#"+rndid+"_"+lastTagId);lastTagObj.after($el);}else{obj.before($el);}}$el.find("#"+newTagRemoveId).on("click",obj,function(e){e.preventDefault();var TagIdToRemove=parseInt($(this).attr("TagIdToRemove"));spliceTag(TagIdToRemove,e.data);});refreshHiddenTagList();if(!ignore_events)obj.trigger('tm:pushed',tag);showOrHide();}obj.val("");};var prefill=function(pta){$.each(pta,function(key,val){pushTag(val,true);});};var killEvent=function(e){e.cancelBubble=true;e.returnValue=false;e.stopPropagation();e.preventDefault();};var keyInArray=function(e,ary){return $.inArray(e.which,ary)!=-1};var applyDelimiter=function(e){pushTag(obj.val());e.preventDefault();};var returnValue=null;this.each(function(){if(typeof options=='string'){switch(options){case"empty":empty();break;case"popTag":popTag();break;case"pushTag":pushTag(tagToManipulate);break;case"tags":returnValue={tags:obj.data("tlis")};break;}return;}if($(this).data('tagManager')){return false;}$(this).data('tagManager',true);var tlis=new Array();var tlid=new Array();obj.data("tlis",tlis);obj.data("tlid",tlid);if(tagManagerOptions.output==null){var hiddenObj=jQuery('<input/>',{type:'hidden',name:tagManagerOptions.hiddenTagListName});obj.after(hiddenObj);obj.data("lhiddenTagList",hiddenObj);}else{obj.data("lhiddenTagList",jQuery(tagManagerOptions.output))}if(tagManagerOptions.AjaxPushAllTags){obj.on('tm:spliced',pushAllTags);obj.on('tm:popped',pushAllTags);obj.on('tm:pushed',pushAllTags);}obj.on('focus keypress',function(e){if($(this).popover){$(this).popover('hide');}});obj.on('focus',function(e){$(this).val('');obj.val("");});if(tagManagerOptions.isClearInputOnEsc){obj.on('keyup',function(e){if(e.which==27){$(this).val('');killEvent(e);}});}obj.on('keypress',function(e){if(keyInArray(e,delimiterChars)){applyDelimiter(e);}});obj.on('keydown',function(e){if(e.which==13){if(tagManagerOptions.preventSubmitOnEnter){killEvent(e);}}if(keyInArray(e,delimiterKeys)){applyDelimiter(e);}});if(tagManagerOptions.deleteTagsOnBackspace){obj.on('keydown',function(e){if(keyInArray(e,backspace)){if($(this).val().length<=0){popTag();killEvent(e);}}});}obj.change(function(e){if(!/webkit/.test(navigator.userAgent.toLowerCase())){$(this).focus();}killEvent(e);});if(tagManagerOptions.prefilled!=null){if(typeof(tagManagerOptions.prefilled)=="object"){prefill(tagManagerOptions.prefilled);}else if(typeof(tagManagerOptions.prefilled)=="string"){prefill(tagManagerOptions.prefilled.split(baseDelimiter));}else if(typeof(tagManagerOptions.prefilled)=="function"){prefill(tagManagerOptions.prefilled());}}else if(tagManagerOptions.output!=null){if(jQuery(tagManagerOptions.output)&&jQuery(tagManagerOptions.output).val())var existing_tags=jQuery(tagManagerOptions.output);prefill(jQuery(tagManagerOptions.output).val().split(baseDelimiter));}});if(!returnValue)returnValue=this;return returnValue;}})(jQuery);